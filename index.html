<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vidéo de prospection Aqisio</title>
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0;
      background: #0b0b0b;
      color: #fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .wrap {
      display: grid;
      place-items: center;
      min-height: 100dvh;
      padding: 24px;
    }
    .player {
      width: min(960px, 100%);
      aspect-ratio: 16/9;
      position: relative;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: 0;
      border-radius: 16px;
    }
    .note {
      opacity: 0.7;
      margin-top: 12px;
      font-size: 0.9rem;
    }

    /* --- Overlay Calendly --- */
    .overlay {
      position: fixed;
      inset: 0;
      display: none;
      background: rgba(0, 0, 0, 0.8);
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 16px;
    }
    .card {
      width: min(800px, 100%);
      background: #111;
      border-radius: 12px;
      padding: 12px;
    }
    .close {
      display: inline-block;
      margin-bottom: 8px;
      cursor: pointer;
      opacity: 0.7;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="player">
      <!-- === Cloudflare Stream (ta vidéo type) === -->
      <iframe
        id="stream-player"
        src="https://customer-g50chvgfq5q94nqo.cloudflarestream.com/5032da31754eb596edf1e9d68cbe031e/iframe?autoplay=true&muted=true"
        allow="autoplay; encrypted-media; picture-in-picture"
        allowfullscreen="true"
      ></iframe>
    </div>
    <p class="note" id="debug"></p>
  </div>

  <!-- Overlay Calendly -->
  <div class="overlay" id="overlay">
    <div class="card">
      <span class="close" id="close">✕ Fermer</span>
      <div
        class="calendly-inline-widget"
        data-url="https://calendly.com/ton-compte/30min"
        style="min-width:320px;height:700px;"
      ></div>
    </div>
  </div>

  <!-- SDK Cloudflare Stream + Calendly -->
  <script src="https://embed.cloudflarestream.com/embed/sdk.latest.js"></script>
  <script src="https://assets.calendly.com/assets/external/widget.js" async></script>

  <script>
    /* === CONFIG === */
    const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbzvwLzbuy8rgvtRELW9ZycZBDvCUdRjQGsoO1olCeXKILoaXug3dkOCIXLPORYpg6Lc5w/exec";
    const videoId = "5032da31754eb596edf1e9d68cbe031e";
    const qs = new URLSearchParams(location.search);
    const prospectId = qs.get("p") || "unknown";
    const sessionId = (crypto.randomUUID && crypto.randomUUID()) || Date.now() + "-" + Math.random();
    const userAgent = navigator.userAgent;

    /* === PLAYER === */
    const player = Stream(document.getElementById("stream-player"));

    // Autoplay robuste
    player.play().catch(async () => {
      try {
        player.muted = true;
        await player.play();
      } catch (_) {}
    });

    /* === TRACKING : secondes uniques vues === */
    let duration = 0;
    let watchedMap = Object.create(null);
    let lastSentAt = 0;

    async function refreshDuration() {
      try {
        duration = Math.floor(await player.duration);
      } catch (_) {}
    }
    refreshDuration();
    setInterval(refreshDuration, 3000);

    const pollMs = 500;
    setInterval(async () => {
      try {
        const paused = await player.paused;
        if (paused) return;
        const t = await player.currentTime;
        watchedMap[Math.floor(t)] = true;
        const now = Date.now();
        if (now - lastSentAt > 10000) {
          lastSentAt = now;
          sendSummary(false);
        }
      } catch (_) {}
    }, pollMs);

    function computeSummary() {
      const secondsWatched = Object.keys(watchedMap).length;
      const percent =
        duration > 0 ? Math.min(100, Math.round((secondsWatched / duration) * 100)) : 0;
      return { secondsWatched, percent };
    }

    async function sendSummary(final = false) {
      const { secondsWatched, percent } = computeSummary();
      document.getElementById("debug").textContent = `Vu ~${secondsWatched}s / ${duration}s (${percent}%)` + (final ? " [final]" : "");

      const payload = {
        prospectId,
        videoId,
        secondsWatched,
        duration,
        percent,
        sessionId,
        userAgent,
        final,
      };
      try {
        await fetch(WEBHOOK_URL, {
          method: "POST",
          // AUCUN header → évite preflight CORS
          body: JSON.stringify(payload),
        });
      } catch (e) {}
    }

    // Envoie un résumé final à la fin ou quand on quitte la page
    player.addEventListener("ended", () => {
      sendSummary(true);
      showCalendly();
    });
    window.addEventListener("beforeunload", () => sendSummary(true));

    /* === CALENDLY === */
    const overlay = document.getElementById("overlay");
    const closeBtn = document.getElementById("close");
    function showCalendly() {
      overlay.style.display = "flex";
    }
    closeBtn.addEventListener("click", () => {
      overlay.style.display = "none";
    });
  </script>
</body>
</html>
