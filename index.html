<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VidÃ©o</title>

  <!-- PrÃ©connexions Cloudflare Stream (player + assets) -->
  <link rel="dns-prefetch" href="https://iframe.cloudflarestream.com">
  <link rel="preconnect" href="https://iframe.cloudflarestream.com" crossorigin>
  <link rel="dns-prefetch" href="https://embed.cloudflarestream.com">
  <link rel="preconnect" href="https://embed.cloudflarestream.com" crossorigin>
  <link rel="dns-prefetch" href="https://videodelivery.net">
  <link rel="preconnect" href="https://videodelivery.net" crossorigin>
  <link rel="dns-prefetch" href="https://imagedelivery.net">
  <link rel="preconnect" href="https://imagedelivery.net" crossorigin>

  <!-- Calendly chargÃ© Ã  la demande (pas de script ici) -->
  <link rel="dns-prefetch" href="https://calendly.com">
  <link rel="preconnect" href="https://calendly.com" crossorigin>

  <style>
    :root { --gap: clamp(12px, 3vw, 32px); }
    html, body { margin:0; height:100%; background:#000; overflow:hidden; }

    .stage { position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; padding: var(--gap); box-sizing: border-box; background:#000; }
    .frame { width: clamp(320px, 88vw, 1100px); aspect-ratio: 16 / 9; max-height: 68vh; border-radius: 14px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,.35); background:#000; position:relative; }
    @media (max-width: 640px) { .frame { width: 96vw; max-height: 58vh; } }

    #player, #poster { width: 100%; height: 100%; border: 0; object-fit: cover; background:#000; display:block; }
    #player { position: absolute; inset: 0; z-index: 2; }
    #poster { position: absolute; inset: 0; z-index: 3; cursor: pointer; }

    /* CTA */
    .cta {
      position: fixed; right: var(--gap); bottom: var(--gap); z-index: 30;
      background:#006BFF; color:#fff; border:0; border-radius:16px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-weight: 700; letter-spacing:.2px; padding: 14px 16px; font-size: 14px; line-height: 1.1;
      box-shadow: 0 10px 30px rgba(0,0,0,.35); cursor:pointer; user-select:none; -webkit-tap-highlight-color: transparent;
    }
    .cta:active { transform: translateY(1px); }
    @media (min-width: 1024px) { .cta { padding: 22px 26px; font-size: 18px; border-radius:20px; } }

    /* Modal Calendly */
    .modal { position:fixed; inset:0; z-index:50; display:none; background:rgba(0,0,0,.65); backdrop-filter:blur(2px); }
    .modal__panel { position:absolute; inset: var(--gap); background:#fff; border-radius:16px; overflow:hidden; display:flex; flex-direction:column; box-shadow: 0 20px 60px rgba(0,0,0,.45); }
    .modal__head { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:#0b1220; color:#fff; font:600 14px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    .modal__close { appearance:none; border:0; background:transparent; color:#fff; cursor:pointer; font-size:18px; padding:6px; line-height:1; }
    .modal__body { flex:1; min-height:420px; background:#fff; }
    .calendly-inline-widget { width:100%; height:100%; min-width:320px; }
  </style>

  <!-- SDK Stream pour les events/tracking -->
  <script src="https://embed.cloudflarestream.com/embed/sdk.latest.js?v=3" defer></script>

  <!-- PrÃ©load du poster le plus tÃ´t possible (selon query) -->
  <script>
    (function preloadPoster(){
      try {
        const qp = new URLSearchParams(location.search);
        const id = (qp.get("id") || "").trim();
        const posterParam = (qp.get("poster") || "").trim();
        if (!/^[a-f0-9]{32}$/i.test(id) && !posterParam) return;

        // Si poster fourni : on l'utilise. Sinon, on prend une vignette JPG sur videodelivery.net
        const posterSrc = posterParam || `https://videodelivery.net/${id}/thumbnails/thumbnail.jpg?time=1s&height=720&fit=clip`;

        const link = document.createElement('link');
        link.rel = 'preload';
        link.as = 'image';
        link.href = posterSrc;
        link.setAttribute('imagesizes', '100vw');
        document.head.appendChild(link);
      } catch (_) {}
    })();
  </script>
</head>
<body>
  <div class="stage">
    <div class="frame">
      <!-- Player en dessous, poster au-dessus (z-index) -->
      <iframe id="player" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen hidden></iframe>
      <img id="poster" alt="Cliquer pour lancer la vidÃ©o" decoding="async" fetchpriority="high">
    </div>
  </div>

  <button id="cta" class="cta">ðŸ“ž RÃ©servez un Rendez-Vous !</button>

  <div id="cal-modal" class="modal" aria-hidden="true">
    <div class="modal__panel" role="dialog" aria-modal="true" aria-label="RÃ©server un rendez-vous">
      <div class="modal__head">
        <span id="modal-title">RÃ©server un rendez-vous</span>
        <button class="modal__close" id="cal-close" aria-label="Fermer">âœ•</button>
      </div>
      <div class="modal__body">
        <div class="calendly-inline-widget"
             data-url="https://calendly.com/aqisio/presentation?hide_event_type_details=1&hide_gdpr_banner=1">
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      "use strict";

      /* ========== 1) PARAMS & UI ========== */
      const qp = new URLSearchParams(location.search);
      const f  = (qp.get("f")  || "").trim();
      const l  = (qp.get("l")  || "").trim();
      const id = (qp.get("id") || "").trim();
      const d  = (qp.get("d")  || "").trim();
      const posterParam = (qp.get("poster") || "").trim();

      if (!/^[a-f0-9]{32}$/i.test(id)) { console.error("Stream ID invalide"); return; }

      const prettyF = f || "Vous";
      document.title = `${prettyF}, regardez la vidÃ©o !`;
      const cta = document.getElementById("cta");
      cta.textContent = `ðŸ“ž ${prettyF}, RÃ©servez un Rendez-Vous !`;

      /* ========== 2) ELEMENTS & SOURCES ========== */
      const iframe = document.getElementById("player");
      const posterEl = document.getElementById("poster");

      // Poster (image ou gif)
      const posterSrc = posterParam || `https://videodelivery.net/${id}/thumbnails/thumbnail.jpg?time=1s&height=720&fit=clip`;
      posterEl.src = posterSrc;

      // DÃ©terminer automatiquement la meilleure URL d'embed pour le player :
      // - si posterParam pointe vers un "customer-xxx.cloudflarestream.com", on utilise ce domaine: /<id>/iframe
      // - sinon, fallback vers iframe.cloudflarestream.com/<id>
      function computePlayerUrls() {
        let primary = `https://iframe.cloudflarestream.com/${id}?v=3&defaultTextTrack=fr`;
        let backup = null;

        try {
          if (posterParam) {
            const u = new URL(posterParam);
            // Exemple: https://customer-xxxx.cloudflarestream.com/<id>/thumbnails/...
            if (u.hostname.endsWith('.cloudflarestream.com') && u.hostname.startsWith('customer-')) {
              const customerBase = `${u.protocol}//${u.hostname}`;
              primary = `${customerBase}/${id}/iframe?defaultTextTrack=fr`; // player du customer domain
              backup  = `https://iframe.cloudflarestream.com/${id}?v=3&defaultTextTrack=fr`; // fallback public
            } else if (u.hostname.endsWith('videodelivery.net')) {
              // si poster sur videodelivery.net, on garde iframe.cloudflarestream.com en primary
              primary = `https://iframe.cloudflarestream.com/${id}?v=3&defaultTextTrack=fr`;
            }
          }
        } catch(e) { /* ignore */ }

        return { primary, backup };
      }

      const { primary: PLAYER_PRIMARY, backup: PLAYER_BACKUP } = computePlayerUrls();

      /* ========== 3) TRACKING helper ========== */
      const sessionId = (self.crypto && crypto.randomUUID)
        ? `sid_${id.slice(0,8)}_${crypto.randomUUID().slice(0,8)}`
        : `sid_${id.slice(0,8)}_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,6)}`;

      const WEB_APP = "https://script.google.com/macros/s/AKfycbyFxJ2lUMtuB44kud-xGFcMGudW2J5G2UWMD2QtjvolJiUpRtA4zeX9e4_KieRIlzaF-g/exec";
      function ping(ev, extra) {
        const base = { ev, f, l, id, d, sessionId, ua:navigator.userAgent, ref:document.referrer||"", w:String(innerWidth||0), h:String(innerHeight||0), ts:String(Date.now()) };
        const payload = new URLSearchParams(Object.assign(base, extra||{}));
        try {
          if (navigator.sendBeacon) {
            const blob = new Blob([payload.toString()], { type:"application/x-www-form-urlencoded" });
            navigator.sendBeacon(WEB_APP, blob); return;
          }
        } catch(_) {}
        fetch(WEB_APP + "?" + payload.toString(), { method:"GET", mode:"no-cors", keepalive:true }).catch(()=>{});
      }
      (function openedOnce(){
        const key = `aqi_opened_${id}_${d||"nodate"}`;
        const first = !localStorage.getItem(key);
        try { localStorage.setItem(key,"1"); } catch(e){}
        ping("opened", { first: first ? "1" : "0", cur:"0", dur:"0" });
      })();

      /* ========== 4) CALENDLY Ã€ LA DEMANDE ========== */
      const modal = document.getElementById("cal-modal");
      const closeBtn = document.getElementById("cal-close");
      let calendlyLoaded = false;

      function loadCalendly(cb){
        if (calendlyLoaded) return cb && cb();
        const s = document.createElement('script');
        s.src = 'https://assets.calendly.com/assets/external/widget.js';
        s.async = true;
        s.onload = () => { calendlyLoaded = true; cb && cb(); };
        document.head.appendChild(s);
      }
      function showCalendly(){
        modal.style.display="block"; modal.setAttribute("aria-hidden","false");
        ping("calendly_open");
        loadCalendly();
      }
      function hideCalendly(){ modal.style.display="none"; modal.setAttribute("aria-hidden","true"); }

      cta.addEventListener("click", ()=>{ ping("cta_click"); showCalendly(); });
      closeBtn.addEventListener("click", hideCalendly);
      modal.addEventListener("click", (e)=>{ if(e.target === modal) hideCalendly(); });
      addEventListener("keydown", (e)=>{ if(e.key==="Escape") hideCalendly(); });

      /* ========== 5) PLAYER : CHARGEMENT & RÃ‰VÃ‰LATION ========== */
      function setIframeSrcOnce(url){
        if (!iframe.src) iframe.src = url;
      }

      // 1) PrÃ©parer le player dÃ¨s que visible (sans l'afficher)
      if ('IntersectionObserver' in window) {
        const io = new IntersectionObserver(entries => {
          if (entries.some(e => e.isIntersecting)) {
            setIframeSrcOnce(PLAYER_PRIMARY);
            io.disconnect();
            // Fallback si Ã§a ne charge pas (2 s)
            setTimeout(() => {
              if (!iframe.contentWindow && PLAYER_BACKUP) {
                setIframeSrcOnce(PLAYER_BACKUP);
              }
            }, 2000);
          }
        });
        io.observe(document.querySelector('.frame'));
      } else {
        setIframeSrcOnce(PLAYER_PRIMARY);
      }

      // 2) Clic sur le poster : montrer immÃ©diatement le player (bouton Play visible)
      function revealPlayer() {
        // S'assurer qu'on a une src
        setIframeSrcOnce(PLAYER_PRIMARY);
        // Si au bout de 1.5 s l'iframe n'est pas initialisÃ©e, on tente l'autre URL
        setTimeout(() => {
          const hasWindow = !!iframe.contentWindow;
          if (!hasWindow && PLAYER_BACKUP) setIframeSrcOnce(PLAYER_BACKUP);
        }, 1500);

        // Montrer le player maintenant (au-dessus ou Ã  la place du poster)
        iframe.hidden = false;
        posterEl.hidden = true;
      }
      posterEl.addEventListener('click', revealPlayer, { passive:true });

      /* ========== 6) SDK Stream + Tracking ========== */
      function onReady(cb){ (document.readyState === "complete" ? cb : addEventListener("load", cb)); }

      onReady(function(){
        if (typeof Stream !== "function") { console.error("SDK Stream indisponible"); return; }
        const player = Stream(iframe);

        // Si le player dÃ©marre, on s'assure d'afficher l'iframe
        player.addEventListener("playing", () => {
          iframe.hidden = false;
          posterEl.hidden = true;
        });

        // --- Tracking Ã  la seconde ---
        let duration = 0, launched = false;
        const sentSeconds = new Set();
        let tick = null;
        const getTimes = () => {
          const ct = Math.max(0, Math.floor(Number(player.currentTime || 0)));
          const du = Math.max(0, Math.floor(Number(player.duration   || duration || 0)));
          if (!duration && du) duration = du;
          return { cur:String(ct), dur:String(du) };
        };
        function startTick(){ if (!tick) tick = setInterval(()=>{ const t=getTimes(); const s=+t.cur; if(!sentSeconds.has(s)){ sentSeconds.add(s); ping("sec",t);} },1000); }
        function stopTick(){ if (tick){ clearInterval(tick); tick=null; } }

        player.addEventListener("durationchange", ()=>{ const du=Math.floor(Number(player.duration||0)); if(du>0) duration=du; });
        player.addEventListener("playing", ()=>{ if(!launched){ launched=true; ping("launched", getTimes()); } startTick(); });
        player.addEventListener("pause",   ()=>{ ping("pause", getTimes()); stopTick(); });
        player.addEventListener("ended",   ()=>{ const t=getTimes(); const s=+t.cur; if(!sentSeconds.has(s)){ sentSeconds.add(s); ping("sec",t);} ping("completed", t); stopTick(); showCalendly(); });

        let from=0; player.addEventListener("seeking", ()=>{ from=+getTimes().cur; });
        player.addEventListener("seeked",  ()=>{ const t=getTimes(); ping("seek", Object.assign({}, t, { from:String(from), to:t.cur })); });

        addEventListener("visibilitychange", ()=>{ if (document.visibilityState==="hidden") ping("hidden", getTimes()); });
        addEventListener("pagehide", ()=>{ ping("pagehide", getTimes()); });
      });
    })();
  </script>

  <noscript>
    <style>.cta{display:none}</style>
    <div style="position:fixed;inset:auto 0 0 0;padding:12px;color:#fff;background:#111;font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;text-align:center">
      Activez JavaScript pour lire la vidÃ©o et rÃ©server un crÃ©neau.
    </div>
  </noscript>
</body>
</html>

