<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vidéo de prospection Aqisio</title>
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0;
      background: #0b0b0b;
      color: #fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .wrap {
      display: grid;
      place-items: center;
      min-height: 100dvh;
      padding: 24px;
    }
    .player {
      width: min(960px, 100%);
      aspect-ratio: 16/9;
      position: relative;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: 0;
      border-radius: 16px;
    }
    .note {
      opacity: .7;
      margin-top: 12px;
      font-size: .9rem;
    }

    /* Bloc Calendly inline (caché au départ) */
    #calendly-block {
      display: none;              /* <- passe à block quand la vidéo se termine */
      width: min(960px, 100%);
      margin: 24px auto;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="player">
      <!-- Cloudflare Stream : ta vidéo type -->
      <iframe id="stream-player"
        src="https://customer-g50chvgfq5q94nqo.cloudflarestream.com/5032da31754eb596edf1e9d68cbe031e/iframe?autoplay=true&muted=true"
        allow="autoplay; encrypted-media; picture-in-picture"
        allowfullscreen="true"></iframe>
    </div>
    <p class="note" id="debug"></p>

    <!-- Calendly inline (embed) -->
    <div id="calendly-block">
      <!-- Début de widget en ligne Calendly -->
      <div class="calendly-inline-widget"
           data-url="https://calendly.com/aqisio/presentation?hide_event_type_details=1&hide_gdpr_banner=1"
           style="min-width:320px;height:700px;"></div>
      <script type="text/javascript"
              src="https://assets.calendly.com/assets/external/widget.js" async></script>
      <!-- Fin de widget en ligne Calendly -->
    </div>
  </div>

  <!-- SDK Cloudflare Stream -->
  <script src="https://embed.cloudflarestream.com/embed/sdk.latest.js"></script>

  <script>
    /***** CONFIG *****/
    const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbz9alEU_7igvcCej_rumzU7mtVQFYiCbUmczzNXpXVzU-1Uz37hHUhAe90z_I4Vstus/exec";
    const VIDEO_ID    = "5032da31754eb596edf1e9d68cbe031e"; // ID Cloudflare Stream
    const qs          = new URLSearchParams(location.search);
    const prospectId  = qs.get("p") || "unknown";
    const userAgent   = navigator.userAgent;

    /***** ÉTAT DE SESSION *****/
    let sessionId, ended, duration, watchedMap, lastSecSent;

    function newSession() {
      sessionId   = (crypto.randomUUID && crypto.randomUUID()) || (Date.now()+"-"+Math.random());
      ended       = false;
      duration    = 0;
      watchedMap  = Object.create(null);
      lastSecSent = -1;
      document.getElementById("debug").textContent = "Session: " + sessionId;
    }
    newSession();

    /***** PLAYER *****/
    const player = Stream(document.getElementById("stream-player"));

    // Autoplay robuste (mute fallback)
    player.play().catch(async () => {
      try { player.muted = true; await player.play(); } catch(_) {}
    });

    // Rafraîchit la durée
    async function refreshDuration() {
      try { duration = Math.floor(await player.duration); } catch(_) {}
    }
    refreshDuration();
    setInterval(refreshDuration, 3000);

    /***** TRACKING (ping conditionnel chaque seconde) *****/
    async function tick() {
      if (ended) return;
      try {
        const paused = await player.paused;
        if (paused) return;

        const t = await player.currentTime;
        const sec = Math.floor(t);
        if (!watchedMap[sec]) {
          watchedMap[sec] = true;
          if (sec !== lastSecSent) {
            lastSecSent = sec;
            sendSummary(false);
          }
        }
      } catch(_) {}
    }
    setInterval(tick, 1000);

    function computeSummary() {
      const secondsWatched = Object.keys(watchedMap).length;
      const percent = duration > 0
        ? Math.min(100, Math.round((secondsWatched / duration) * 100))
        : 0;
      return { secondsWatched, percent };
    }

    async function sendSummary(final=false) {
      const { secondsWatched, percent } = computeSummary();
      document.getElementById("debug").textContent =
        `Session: ${sessionId} — ${secondsWatched}s / ${duration}s (${percent}%)` +
        (final ? " [final]" : "");

      const payload = {
        prospectId,
        videoId: VIDEO_ID,
        secondsWatched,
        duration,
        percent,
        sessionId,
        userAgent,
        final
      };

      try {
        await fetch(WEBHOOK_URL, {
          method: "POST",
          body: JSON.stringify(payload) // aucun header -> évite preflight CORS
        });
      } catch(e) {}
    }

    // Fin de vidéo → ping final, stop ping, affiche Calendly inline
    player.addEventListener("ended", () => {
      if (ended) return;
      ended = true;
      sendSummary(true);

      // Affiche le bloc Calendly et scroll dessus
      const block = document.getElementById("calendly-block");
      block.style.display = "block";
      block.scrollIntoView({ behavior: "smooth", block: "start" });
    });

    // Replay → nouvelle session si redémarrage au début
    player.addEventListener("play", async () => {
      if (!ended) return;
      try {
        const t = await player.currentTime;
        if (t < 1) {
          newSession(); // nouvelle ligne (session) côté Sheets
        }
      } catch(_) {}
    });
  </script>
</body>
</html>
