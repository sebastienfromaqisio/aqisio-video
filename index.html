<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Regardez la Vid√©o ‚Äî Aqisio</title>

  <!-- Video.js (CDN) -->
  <link href="https://unpkg.com/video.js@8/dist/video-js.css" rel="stylesheet">
  <script defer src="https://unpkg.com/video.js@8/dist/video.min.js"></script>

  <!-- hls.js charg√© seulement si n√©cessaire -->
  <script defer src="https://unpkg.com/hls.js@1.5.13/dist/hls.min.js"></script>

  <style>
    :root { color-scheme: dark; }
    body { margin:0; background:#0b0b0b; color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    .wrap { min-height:100dvh; display:grid; place-items:center; padding:16px; }

    /* Container pour placer les overlays */
    .player-shell { position:relative; width:min(1200px, 100%); }

    /* Aspect Loom : bulle de sous-titres */
    .caption-bubble {
      position:absolute; left:50%; transform:translateX(-50%);
      bottom:10%; /* ~au-dessus de la barre de contr√¥le */
      max-width:min(90%, 1000px);
      background:#1a73e8;  /* bleu Loom-like */
      color:#fff; font-weight:600; line-height:1.35;
      padding:14px 18px; border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      pointer-events:none; /* pas cliquable */
      opacity:0; transition:opacity .15s ease;
      text-align:center; font-size:clamp(14px, 2.2vw, 22px);
    }

    /* CTA en haut-droite (dans la vid√©o) */
    .cta {
      position:absolute; top:14px; right:14px; z-index:3;
      background:#1a73e8; color:#fff; font-weight:700;
      padding:10px 16px; border-radius:999px;
      box-shadow:0 8px 24px rgba(0,0,0,.35);
      text-decoration:none;
    }
    .cta:hover { filter:brightness(1.08); }

    /* Vid√©o responsive */
    .video-js { width:100%; height:auto; aspect-ratio:16/9; background:#000; border-radius:12px; overflow:hidden; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="player-shell">
      <!-- CTA overlay -->
      <a class="cta" id="ctaLink" href="https://calendly.com/aqisio/30min" target="_blank" rel="noopener">
        üìû R√©servez un RDV !
      </a>

      <!-- Player -->
      <video
        id="aqisioPlayer"
        class="video-js vjs-default-skin"
        controls
        playsinline
        preload="metadata"
      >
        <!-- CF Stream HLS manifest -->
        <source src="https://videodelivery.net/VIDE0_ID/manifest/video.m3u8" type="application/x-mpegURL" />

        <!-- On garde le VTT pour r√©cup√©rer les cues, mais on ne l‚Äôaffiche pas tel quel -->
        <track id="vttTrack" kind="subtitles" srclang="fr" label="Fran√ßais"
               src="https://pub-xxx.r2.dev/sous-titres.vtt" default>
      </video>

      <!-- Bulle de sous-titres style Loom -->
      <div id="captionBubble" class="caption-bubble" aria-live="polite"></div>
    </div>
  </div>

  <script>
    // 1) Init Video.js
    const player = videojs('aqisioPlayer', {
      controls: true,
      preload: 'metadata'
    });

    // 2) Fallback HLS.js si n√©cessaire (Safari/iOS lisent HLS nativement)
    (function ensureHls() {
      const src = player.currentSource()?.src;
      const needsHls = !!src && src.endsWith('.m3u8') && !player.tech(true).featuresNativeHls;
      if (needsHls && window.Hls?.isSupported?.()) {
        const video = player.tech().el(); // <video> natif
        const hls = new Hls();
        hls.loadSource(src);
        hls.attachMedia(video);
      }
    })();

    // 3) ‚ÄúRenderer‚Äù overlay : on lit les cues du track en mode cach√© et on les affiche dans la bulle
    const videoEl = player.tech().el();
    const captionBubble = document.getElementById('captionBubble');

    // R√©cup√©rer le TextTrack (le mettre en hidden pour acc√©der aux cues sans affichage natif)
    let textTrack;
    videoEl.addEventListener('loadedmetadata', () => {
      // Prendre le premier track de type 'subtitles'
      for (const tt of videoEl.textTracks) {
        if (tt.kind === 'subtitles') { textTrack = tt; break; }
      }
      if (textTrack) {
        textTrack.mode = 'hidden';
        textTrack.addEventListener('cuechange', renderCue);
      }
      renderCue(); // au cas o√π un cue est d√©j√† actif
    });

    function renderCue() {
      if (!textTrack) return;
      const cue = textTrack.activeCues?.[0];
      if (cue && cue.text) {
        // Optionnel : convertir WebVTT avec tags en texte simple
        const html = cue.text
          .replace(/<\/?[^>]+(>|$)/g, '') // strip basique des balises
          .replace(/\n/g, ' ');
        captionBubble.textContent = html.trim();
        captionBubble.style.opacity = '1';
      } else {
        captionBubble.style.opacity = '0';
      }
    }

    // 4) Tracking minimal (ex: paliers 25/50/75/100 % + √©v√©nements cl√©s)
    const milestones = new Set([25,50,75,100]);
    function send(eventName, payload={}) {
      // TODO: remplace par ton webhook Apps Script
      // fetch('https://script.google.com/macros/s/xxx/exec', {method:'POST', body:JSON.stringify({event:eventName, ...payload})});
      console.log('[track]', eventName, payload);
    }
    player.on('play',  () => send('play'));
    player.on('pause', () => send('pause'));
    player.on('ended', () => send('ended'));

    player.on('timeupdate', () => {
      const p = (player.currentTime() / player.duration()) * 100;
      for (const m of [...milestones]) {
        if (p >= m) {
          send('progress', { milestone: m });
          milestones.delete(m);
        }
      }
    });

    // 5) (Optionnel) Personnaliser le CTA avec ?f=Jean&l=Dupont
    const params = new URLSearchParams(location.search);
    const f = params.get('f') || '';
    const cta = document.getElementById('ctaLink');
    if (f) cta.textContent = `üìû ${f}, r√©servez un RDV !`;
  </script>
</body>
</html>
