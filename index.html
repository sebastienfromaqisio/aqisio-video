<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vidéo de prospection Aqisio</title>
  <style>
    :root { color-scheme: dark; }
    body{ margin:0; background:#0b0b0b; color:#fff;
          font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    .wrap{ display:grid; place-items:center; min-height:100dvh; padding:24px; }
    .player{ width:min(960px,100%); aspect-ratio:16/9; position:relative; }
    iframe{ width:100%; height:100%; border:0; border-radius:16px; }
    .note{ opacity:.7; margin-top:12px; font-size:.9rem; }

    /* Overlay Calendly */
    .overlay{ position:fixed; inset:0; display:none; background:rgba(0,0,0,.8);
              align-items:center; justify-content:center; z-index:9999; padding:16px; }
    .card{ width:min(800px,100%); background:#111; border-radius:12px; padding:12px; }
    .close{ display:inline-block; margin-bottom:8px; cursor:pointer; opacity:.7; font-size:.9rem; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="player">
      <!-- Cloudflare Stream : ta vidéo type -->
      <iframe id="stream-player"
        src="https://customer-g50chvgfq5q94nqo.cloudflarestream.com/5032da31754eb596edf1e9d68cbe031e/iframe?autoplay=true&muted=true"
        allow="autoplay; encrypted-media; picture-in-picture"
        allowfullscreen="true"></iframe>
    </div>
    <p class="note" id="debug"></p>
  </div>

  <!-- Overlay Calendly -->
  <div class="overlay" id="overlay">
    <div class="card">
      <span class="close" id="close">✕ Fermer</span>
      <div class="calendly-inline-widget"
           data-url="https://calendly.com/ton-compte/30min"
           style="min-width:320px;height:700px;"></div>
    </div>
  </div>

  <!-- SDK Cloudflare Stream + Calendly -->
  <script src="https://embed.cloudflarestream.com/embed/sdk.latest.js"></script>
  <script src="https://assets.calendly.com/assets/external/widget.js" async></script>

  <script>
    /***** CONFIG *****/
    const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbw2zW3VYkhgIhuB2VpaoeXP_xoNd1nT2HWkHTiTOxHO1OS9koOf9mmljqK7RpsVvDRi7w/exec";
    const VIDEO_ID    = "5032da31754eb596edf1e9d68cbe031e"; // fixe pour cette vidéo
    const qs          = new URLSearchParams(location.search);
    const prospectId  = qs.get("p") || "unknown";
    const userAgent   = navigator.userAgent;

    /***** STATE (session) *****/
    let sessionId, ended, duration, watchedMap, lastSecSent;

    function newSession() {
      sessionId  = (crypto.randomUUID && crypto.randomUUID()) || (Date.now()+"-"+Math.random());
      ended      = false;
      duration   = 0;
      watchedMap = Object.create(null); // ensemble de secondes uniques vues
      lastSecSent = -1;                 // dernière seconde envoyée (pour limiter les envois)
      document.getElementById("debug").textContent = "Session: " + sessionId;
    }
    newSession();

    /***** PLAYER *****/
    const player = Stream(document.getElementById("stream-player"));

    // Autoplay robuste (mute fallback)
    player.play().catch(async () => {
      try { player.muted = true; await player.play(); } catch(_) {}
    });

    // Durée : refresh régulier
    async function refreshDuration() {
      try { duration = Math.floor(await player.duration); } catch(_) {}
    }
    refreshDuration(); setInterval(refreshDuration, 3000);

    /***** TRACKING (ping conditionnel 1 Hz, 1 ligne/session) *****/
    // -> on n'envoie qu'à la découverte d'une nouvelle seconde unique
    async function tick() {
      if (ended) return;
      try {
        const paused = await player.paused;
        if (paused) return;

        const t = await player.currentTime; // float (s)
        const sec = Math.floor(t);
        if (!watchedMap[sec]) {
          watchedMap[sec] = true;

          // n'envoie que si cette "seconde" n'a pas déjà été envoyée (évite spam)
          if (sec !== lastSecSent) {
            lastSecSent = sec;
            sendSummary(false); // upsert partiel (1/s max en lecture continue)
          }
        }
      } catch(_) {}
    }
    setInterval(tick, 1000); // 1 Hz

    function computeSummary() {
      const secondsWatched = Object.keys(watchedMap).length;
      const percent = duration > 0 ? Math.min(100, Math.round((secondsWatched / duration) * 100)) : 0;
      return { secondsWatched, percent };
    }

    async function sendSummary(final=false) {
      const { secondsWatched, percent } = computeSummary();
      document.getElementById("debug").textContent =
        `Session: ${sessionId} — ${secondsWatched}s / ${duration}s (${percent}%)` + (final ? " [final]" : "");

      const payload = {
        prospectId, videoId: VIDEO_ID, secondsWatched, duration, percent,
        sessionId, userAgent, final
      };
      try {
        await fetch(WEBHOOK_URL, {
          method: "POST",
          // PAS de headers -> évite preflight CORS
          body: JSON.stringify(payload)
        });
      } catch(e) { /* silencieux MVP */ }
    }

    // Fin de vidéo -> ping final, stop pings, ouvre Calendly
    player.addEventListener("ended", () => {
      if (ended) return;
      ended = true;
      sendSummary(true);
      showCalendly();
    });

    // Replay -> si on était en "ended" et que l'utilisateur relance au début, on crée une NOUVELLE session
    player.addEventListener("play", async () => {
      if (!ended) return;
      try {
        const t = await player.currentTime;
        if (t < 1) {        // relance depuis le début => nouvelle session
          newSession();
          // on enverra la première MAJ dès la 1ère seconde vue
        }
      } catch(_) {}
    });

    /***** CALENDLY *****/
    const overlay = document.getElementById("overlay");
    const closeBtn = document.getElementById("close");
    function showCalendly(){ overlay.style.display = "flex"; }
    closeBtn.addEventListener("click", () => { overlay.style.display = "none"; });
  </script>
</body>
</html>
