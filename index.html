<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Regardez la VidÃ©o â€” Aqisio</title>
  <style>
    :root { color-scheme: dark; }
    body{margin:0;background:#0b0b0b;color:#fff;font-family:system-ui;}
    .wrap{display:grid;place-items:center;min-height:100vh;padding:24px;}
    .player{width:min(960px,100%);aspect-ratio:16/9;position:relative;border-radius:16px;overflow:hidden;background:#000;}
    iframe{width:100%;height:100%;border:0;}
    button{margin-top:20px;padding:16px 28px;border-radius:12px;background:#0156CC;color:#fff;font-weight:700;border:0;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="player">
      <iframe id="stream-player" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>
    </div>
    <button id="cta">ðŸ“ž RÃ©servez un Rendez-vous</button>
  </div>

  <script src="https://embed.cloudflarestream.com/embed/sdk.latest.js"></script>
  <script>
    const qs = new URLSearchParams(location.search);
    const f = qs.get('f')||'', l = qs.get('l')||'', id = qs.get('id')||'5032da31754eb596edf1e9d68cbe031e';
    const prospectId = `${decodeURIComponent(f)}${decodeURIComponent(l)}-${id}`;
    const playerIframe = document.getElementById('stream-player');
    playerIframe.src = `https://iframe.videodelivery.net/${id}?controls=true&playsinline=true&defaultTextTrack=fr`;

    const WEBHOOK = "https://script.google.com/macros/s/AKfycbz9alEU_7igvcCej_rumzU7mtVQFYiCbUmczzNXpXVzU-1Uz37hHUhAe90z_I4Vstus/exec";
    let player=null, ended=false, watched={}, duration=0, sessionId=crypto.randomUUID();

    function meta(){
      const ua=navigator.userAgent;
      return {
        userAgent: ua,
        language: navigator.language,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        screen_resolution: `${screen.width}x${screen.height}`,
        device_type: /Mobi/i.test(ua)?'mobile':'desktop'
      };
    }

    function buildPayload(final=false){
      const secondsWatched=Object.keys(watched).length;
      const pct=duration?Math.min(100,Math.round(secondsWatched/duration*100)):0;
      return {...meta(), prospectId, videoId:id, secondsWatched, duration, percent:pct,
        sessionId, final, is_replay:false, replay_count:0};
    }

    function post(data,keepalive=false){
      if(keepalive&&navigator.sendBeacon){
        navigator.sendBeacon(WEBHOOK,new Blob([JSON.stringify(data)],{type:'text/plain'}));
      }else{
        fetch(WEBHOOK,{method:'POST',body:JSON.stringify(data)});
      }
    }

    playerIframe.addEventListener('load',()=>{player=Stream(playerIframe);startWait();});
    function startWait(){
      const wait=setInterval(async()=>{
        if(!player) return;
        clearInterval(wait);
        const poll=setInterval(async()=>{
          if(!player) return;
          try{
            const paused=await player.paused;
            if(paused===false){clearInterval(poll);track();}
          }catch(_){}
        },300);
      },50);
    }

    async function track(){
      ended=false; watched={};
      try{duration=Math.floor(await player.duration);}catch(_){duration=0;}
      const int=setInterval(async()=>{
        if(!player||ended){clearInterval(int);return;}
        try{
          const paused=await player.paused;
          if(paused) return;
          const t=Math.floor(await player.currentTime);
          if(!watched[t]){watched[t]=1;post(buildPayload(false));}
        }catch(_){}
      },1000);
      player.addEventListener('ended',()=>{if(ended)return;ended=true;post(buildPayload(true));});
    }

    window.addEventListener('beforeunload',()=>post(buildPayload(true),true));
  </script>
</body>
</html>
