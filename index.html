<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vidéo de prospection Aqisio</title>

  <!-- Optim Calendly -->
  <link rel="preconnect" href="https://assets.calendly.com" crossorigin>
  <link rel="preconnect" href="https://calendly.com" crossorigin>
  <link rel="preload" as="script" href="https://assets.calendly.com/assets/external/widget.js">

  <style>
    :root { color-scheme: dark; }
    body{ margin:0; background:#0b0b0b; color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    .wrap{ display:grid; place-items:center; min-height:100dvh; padding:24px; }

    .player{
      width:min(960px,100%);
      aspect-ratio:16/9;
      position:relative;
      border-radius:16px;
      overflow:hidden;
      box-shadow:0 10px 40px rgba(0,0,0,.45);
      background:#000;
    }
    .player iframe{
      width:100%; height:100%;
      border:0; border-radius:16px;
      position:relative; z-index:1; display:block;
    }

    /* CTA bas-droite */
    .cta-btn{
      position:absolute; bottom:16px; right:16px; z-index:3;
      background:#0156CC; color:#fff; border:0; border-radius:16px;
      padding:20px 36px; font-weight:700; font-size:22px; line-height:1;
      cursor:pointer; box-shadow:0 8px 24px rgba(1,86,204,.45);
      transition:transform .12s, opacity .12s, box-shadow .12s; pointer-events:auto;
    }
    .cta-btn:hover{ transform:translateY(-2px); box-shadow:0 10px 30px rgba(1,86,204,.55); }
    .cta-btn:active{ transform:translateY(0); opacity:.95; }
    @media (max-width:768px){
      .cta-btn{ bottom:12px; right:12px; padding:14px 22px; font-size:16px; border-radius:12px; }
    }

    .note{ opacity:.7; margin-top:12px; font-size:.9rem; text-align:center; }

    /* Popup Calendly (préchargée, invisible au départ) */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:grid; place-items:center; z-index:9999;
      transition:opacity .18s, visibility .18s; }
    .overlay.hidden{ opacity:0; visibility:hidden; pointer-events:none; }
    .modal{ width:min(980px,96vw); height:min(760px,88vh); background:#101012; border:1px solid rgba(255,255,255,.08);
      border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.45); overflow:hidden; transform:translateY(6px);
      transition:transform .18s, opacity .18s; opacity:1; }
    .overlay.hidden .modal{ transform:translateY(12px); opacity:0; }
    .modal-head{ display:flex; align-items:center; justify-content:space-between; padding:10px 14px; background:#0c0c0f; border-bottom:1px solid rgba(255,255,255,.06); }
    .modal-title{ margin:0; font-size:.95rem; opacity:.9; }
    .close-btn{ border:0; background:#1a1a1f; color:#fff; border-radius:8px; padding:6px 10px; cursor:pointer; opacity:.9; }
    .calendly-host{ width:100%; height:calc(100% - 46px); }
    .calendly-inline-widget{ width:100%; height:100%; }
  </style>

  <!-- Script Calendly (chargé d’emblée) -->
  <script src="https://assets.calendly.com/assets/external/widget.js" async></script>
</head>
<body>
  <div class="wrap">
    <div class="player">
      <!-- CTA -->
      <button id="ctaBtn" class="cta-btn" aria-label="Prendre rendez-vous">Prendre RDV</button>

      <!-- Cloudflare Stream -->
      <iframe id="stream-player"
        src="https://customer-g50chvgfq5q94nqo.cloudflarestream.com/5032da31754eb596edf1e9d68cbe031e/iframe?autoplay=true&muted=true"
        allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen="true"></iframe>
    </div>

    <p class="note" id="debug"></p>
  </div>

  <!-- Modal Calendly -->
  <div id="calOverlay" class="overlay hidden" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="calTitle">
      <div class="modal-head">
        <h2 id="calTitle" class="modal-title">Réserve un créneau avec Aqisio</h2>
        <button id="calClose" class="close-btn">Fermer</button>
      </div>
      <div class="calendly-host">
        <div class="calendly-inline-widget"
             data-url="https://calendly.com/aqisio/presentation?hide_event_type_details=1&hide_gdpr_banner=1"></div>
      </div>
    </div>
  </div>

  <!-- SDK Cloudflare Stream -->
  <script src="https://embed.cloudflarestream.com/embed/sdk.latest.js"></script>

  <script>
    /********************
     * CONFIG
     ********************/
    const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbz9alEU_7igvcCej_rumzU7mtVQFYiCbUmczzNXpXVzU-1Uz37hHUhAe90z_I4Vstus/exec";
    const VIDEO_ID    = "5032da31754eb596edf1e9d68cbe031e";
    const qs          = new URLSearchParams(location.search);
    const prospectId  = qs.get("p") || "unknown";

    /********************
     * UA + ENV (enrichi)
     ********************/
    function parseUA(ua){
      ua = ua || navigator.userAgent || '';
      let osName='Unknown', osVersion='', browserName='Unknown', browserVersion='', deviceType='desktop';
      if (/Windows NT/i.test(ua)){ osName='Windows'; const m=ua.match(/Windows NT ([\d\.]+)/i); osVersion=m?m[1]:''; }
      else if (/Mac OS X/i.test(ua) && !/like Mac OS X/.test(ua)){ osName='macOS'; const m=ua.match(/Mac OS X ([\d_]+)/i); osVersion=m?m[1].replace(/_/g,'.'):''; }
      else if (/iPhone|iPad|iPod/i.test(ua)){ osName='iOS'; const m=ua.match(/OS ([\d_]+) like Mac OS X/i); osVersion=m?m[1].replace(/_/g,'.'):''; }
      else if (/Android/i.test(ua)){ osName='Android'; const m=ua.match(/Android ([\d\.]+)/i); osVersion=m?m[1]:''; }
      else if (/Linux/i.test(ua)){ osName='Linux'; }
      if (/Edg\//.test(ua)){ browserName='Edge'; const m=ua.match(/Edg\/([\d\.]+)/); browserVersion=m?m[1]:''; }
      else if (/OPR\//.test(ua)){ browserName='Opera'; const m=ua.match(/OPR\/([\d\.]+)/); browserVersion=m?m[1]:''; }
      else if (/Chrome\//.test(ua) && !/Chromium/.test(ua)){ browserName='Chrome'; const m=ua.match(/Chrome\/([\d\.]+)/); browserVersion=m?m[1]:''; }
      else if (/Safari\//.test(ua) && /Version\//.test(ua) && !/Chrome|Chromium/.test(ua)){ browserName='Safari'; const m=ua.match(/Version\/([\d\.]+)/); browserVersion=m?m[1]:''; }
      else if (/Firefox\//.test(ua)){ browserName='Firefox'; const m=ua.match(/Firefox\/([\d\.]+)/); browserVersion=m?m[1]:''; }
      else if (/Chromium\//.test(ua)){ browserName='Chromium'; const m=ua.match(/Chromium\/([\d\.]+)/); browserVersion=m?m[1]:''; }
      if (/Tablet|iPad/i.test(ua)) deviceType='tablet';
      else if (/Mobile|iPhone|Android.*Mobile/i.test(ua)) deviceType='mobile';
      return { browserName, browserVersion, osName, osVersion, deviceType };
    }
    const ua = navigator.userAgent || '';
    const { browserName, browserVersion, osName, osVersion, deviceType } = parseUA(ua);
    const language  = navigator.language || '';
    const timezone  = (Intl.DateTimeFormat().resolvedOptions().timeZone) || '';
    const screen_resolution = `${(screen && screen.width)||0}x${(screen && screen.height)||0}`;

    /********************
     * REPLAY COUNT (localStorage)
     ********************/
    function getReplayKey(pid){ return `aqisio:replay:${pid}`; }
    function getReplayCount(pid){ const v=Number(localStorage.getItem(getReplayKey(pid))||0); return isFinite(v)&&v>=0?v:0; }
    function incReplayCount(pid){ const v=getReplayCount(pid)+1; localStorage.setItem(getReplayKey(pid), String(v)); return v; }

    /********************
     * SESSION STATE
     ********************/
    let sessionId, ended, duration, watchedMap, lastSecSent, isReplay, replayCount;
    function newSession(markReplay=false){
      sessionId   = (crypto.randomUUID && crypto.randomUUID()) || (Date.now()+"-"+Math.random());
      ended       = false;
      duration    = 0;
      watchedMap  = Object.create(null); // secondes uniques vues
      lastSecSent = -1;
      if (markReplay){ isReplay=true; replayCount=incReplayCount(prospectId); }
      else { isReplay=false; if (getReplayCount(prospectId)===0) localStorage.setItem(getReplayKey(prospectId),'0'); replayCount=getReplayCount(prospectId); }
      show(`Session: ${sessionId} — replays: ${replayCount}${isReplay?' (replay)':''}`);
    }
    newSession(false);

    /********************
     * PLAYER
     ********************/
    const player = Stream(document.getElementById("stream-player"));
    player.play().catch(async ()=>{ try{ player.muted=true; await player.play(); }catch(_){} });

    async function refreshDuration(){ try{ duration = Math.floor(await player.duration); }catch(_){} }
    refreshDuration(); setInterval(refreshDuration, 3000);

    /********************
     * TRACKING (1s, seconds uniques)
     ********************/
    setInterval(async () => {
      if (ended) return;
      try {
        const paused = await player.paused;
        if (paused) return;
        const t = Math.floor(await player.currentTime);
        if (!watchedMap[t]) {
          watchedMap[t] = true;
          if (t !== lastSecSent) {
            lastSecSent = t;
            sendSummary(false);
          }
        }
      } catch(_) {}
    }, 1000);

    function computeSummary(){
      const secondsWatched = Object.keys(watchedMap).length;
      const pct = duration>0 ? Math.min(100, Math.round((secondsWatched/duration)*100)) : 0;
      return { secondsWatched, pct };
    }

    async function sendSummary(final=false){
      const { secondsWatched, pct } = computeSummary();
      show(`Session: ${sessionId} — ${secondsWatched}s / ${duration}s (${pct}%) — replays:${replayCount}${isReplay?' (replay)':''}` + (final ? " [final]" : ""));

      const payload = {
        prospectId,
        videoId: VIDEO_ID,
        secondsWatched,
        duration,
        percent: pct,
        sessionId,
        userAgent: ua,
        final,
        // enrichissements
        language, timezone, screen_resolution,
        device_type: deviceType,
        browser_name: browserName, browser_version: browserVersion,
        os_name: osName, os_version: osVersion,
        is_replay: isReplay, replay_count: replayCount
      };

      try {
        await fetch(WEBHOOK_URL, { method:"POST", body: JSON.stringify(payload) }); // <— pas de Content-Type
      } catch(e) { /* ignore */ }
    }

    player.addEventListener("ended", () => {
      if (ended) return;
      ended = true;
      sendSummary(true);
      openCalendly();
    });

    player.addEventListener("play", async () => {
      if (!ended) return;
      try{
        const t = await player.currentTime;
        if (t < 1) newSession(true);
      }catch(_){}
    });

    /********************
     * CALENDLY POPUP
     ********************/
    const calOverlay = document.getElementById('calOverlay');
    const calClose   = document.getElementById('calClose');
    const ctaBtn     = document.getElementById('ctaBtn');
    function openCalendly(){ calOverlay.classList.remove('hidden'); calOverlay.setAttribute('aria-hidden','false'); }
    function closeCalendly(){ calOverlay.classList.add('hidden'); calOverlay.setAttribute('aria-hidden','true'); }
    calClose.addEventListener('click', closeCalendly);
    ctaBtn.addEventListener('click', openCalendly);
    window.addEventListener('keydown', e => { if (e.key === 'Escape') closeCalendly(); });

    /********************
     * UI debug
     ********************/
    function show(msg){ const el=document.getElementById('debug'); if(el) el.textContent=msg; }
  </script>
</body>
</html>
